<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>兄弟连年会----二等奖</title>
    <link href="//cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">
    <link href="./css/style.css" rel="stylesheet"/>
    <script type="text/javascript" src="./js/move.js"></script>
</head>

<body>
<ul>
</ul>
<div class="clear"></div>
<div class="border1"></div>
<div class="border2"></div>
<div class="centent">
    <button class="btn btn-success start" style="margin: 0px auto;display: block;">抽奖</button>
</div>
<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
<script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script>
    var names = ["PHP于倩", "于倩", "于晓春"];
    var level3 = JSON.parse(sessionStorage.getItem('level3'));
    var topMin = leftMin = topMax = leftMax = 0;
    for (var i = 0; i < names.length; i++) {
        if (names[i] == level3[0] || names[i] == level3[1] || names[i] == level3[2]) {
            names.splice(i, 1);
        }
    }

    names.sort(function () {
        return 0.5 - Math.random();
    });
    for (var i = 0; i < 80; i++) {
        $('ul').append('<li><img src="./images/' + names[i] + '.jpg"/><img class="bj" src="./images/bj.png"/></li>');
    }
    window.onload = function () {
        var aLi = document.getElementsByTagName('li');
        var zIndex = 1;

        // 布局转换
        aPos = [];
        for (var i = 0; i < aLi.length; i++) {
            aPos.push({
                left: aLi[i].offsetLeft,
                top: aLi[i].offsetTop
            });
        }

        for (var i = 0; i < aLi.length; i++) {
            aLi[i].style.position = 'absolute';
            aLi[i].style.left = aPos[i].left + 'px';
            aLi[i].style.top = aPos[i].top + 'px';
            aLi[i].style.margin = 0;
        }


        i = 0;
        var timer = null;
        var stime = ran(5, 8) * 1000;
        var timer1 = null, timer2 = null, timerStop = null;
        $('.start').click(function () {
            topMin = parseInt($('ul li:eq(0)').css('top'));
            leftMin = parseInt($('ul li:eq(0)').css('left'));
            topMax = parseInt($('ul li').eq(names.length - 1).css('top'));
            leftMax = parseInt($('ul li').eq(names.length - 1).css('left'));
            $(this).hide();
            for (i = 0; i < 80; i++) {
                fanpai(i);
            }
            //立即翻牌
            setTimeout(function () {
                shuffle(3);
            }, 2000);
            //3秒后洗牌
            setTimeout(function () {
                var liObj = $('ul li:eq(' + ran(0, 79) + ')');
                $('.border1').css({'display': 'block', 'top': liObj.css('top'), 'left': liObj.css('left')});
                liObj = $('ul li:eq(' + ran(0, 79) + ')');
                $('.border2').css({'display': 'block', 'top': liObj.css('top'), 'left': liObj.css('left')});
                timer1 = setInterval(function () {
                    topLeft = moveValue($('.border1'), ran(0, 3));
                    moveNext($('.border1'), topLeft.top, topLeft.left);
                }, 100);
                timer2 = setInterval(function () {
                    topLeft = moveValue($('.border2'), ran(0, 3));
                    var top2 = parseInt($('.border1').css('top'));
                    var left2 = parseInt($('.border1').css('left'));
                    if(topLeft.top == top2 && topLeft.left == left2)
                    {
                        topLeft = moveValue($('.border2'), ran(0, 3));
                    }
                    //如果第二个移动到第一个的位置的话,那么再移动一次,确保每次的结果都不相同
                    moveNext($('.border2'), topLeft.top, topLeft.left);
                }, 100);
            }, 5000);
            //5秒后开始抽奖
            setTimeout(function () {
                clearInterval(timer1);
                timer1 = null;
                clearInterval(timer2);
                timer2 = null;
                for (i = 0; i < 80; i++) {
                    fanpai(i);
                }
                return false;
            }, stime + 5000);
        });
        /**
         * 翻开指定位置的头像
         * @param index
         */
        function fanpai(index) {
            if ($('ul li:eq(' + index + ') img').eq(0).css('display') == 'none') {
                $('li:eq(' + index + ') img').eq(1).stop().animate({'width': 0}, 1000, function () {
                    $('li:eq(' + index + ') img').eq(1).hide().prev().show();
                    $('li:eq(' + index + ') img').eq(0).animate({'width': '110px'}, 1000);
                });
            }
            else {
                $('li:eq(' + index + ') img').eq(0).stop().animate({'width': 0}, 1000, function () {
                    $('li:eq(' + index + ') img').eq(0).hide().next().show();
                    $('li:eq(' + index + ') img').eq(1).animate({'width': '110px'}, 1000);
                });
            }

        }

        /**
         * 移动指定节点到指定位置
         * @param obj
         * @param top
         * @param left
         */
        function moveNext(obj, top, left) {
            $(obj).css({'top': top});
            $(obj).css({'left': left});
        }

        /**
         * 计算指定节点下一个位置的坐标,并返回计算出的坐标
         * @param obj
         * @param direction
         * @returns {{top: Number, left: Number}}
         */
        function moveValue(obj, direction) {
            var top = parseInt($(obj).css('top')), left = parseInt($(obj).css('left'));
            switch (direction) {
                case 0:
                    if (top <= topMin) {
                        top = topMax;
                    } else {
                        top -= 120;
                    }
                    break;
                case 1:
                    if (top >= topMax) {
                        top = topMin;
                    } else {
                        top += 120;
                    }
                    break;
                case 2:
                    if (left <= leftMin) {
                        left = leftMax;
                    } else {
                        left -= 120;
                    }
                    break;
                default:
                    if (left >= leftMax) {
                        left = leftMin;
                    } else {
                        left += 120;
                    }
            }
            return {'top': top, 'left': left};
        }

        function ran(min, max) {
            return parseInt(Math.random() * (max - min + 1) + min)
        }

        function shuffle(num) {
            for (var i = 0; i < num; i++) {
                setTimeout(function () {
                    aPos.sort(function () {
                        return Math.random() - 0.5;
                    });
                    for (var i = 0; i < aLi.length; i++) {
                        move(aLi[i], aPos[i]);
                    }
                }, i * 1000);
            }
        }
    };
</script>
</body>
</html>







